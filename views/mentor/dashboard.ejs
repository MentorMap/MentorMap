<!DOCTYPE html>
<html lang="en">
<head>
	<%- include('../partials/meta', {pageTitle: 'Dashboard'}); %>

	<!-- Bootstrap -->
	<link href="/vendor/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome -->
	<link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<!-- iCheck -->
	<link href="/vendor/iCheck/skins/flat/green.css" rel="stylesheet">
	<!-- PNotify -->
	<link href="/vendor/pnotify/dist/pnotify.css" rel="stylesheet">
	<link href="/vendor/pnotify/dist/pnotify.buttons.css" rel="stylesheet">
	<link href="/vendor/pnotify/dist/pnotify.brighttheme.css" rel="stylesheet">
	<link href="/vendor/pnotify/dist/pnotify.nonblock.css" rel="stylesheet">
	<!-- FullCalendar -->
	<link href="/vendor/fullcalendar/dist/fullcalendar.min.css" rel="stylesheet">
	<link href="/vendor/fullcalendar/dist/fullcalendar.print.css" rel="stylesheet" media="print">
	<!-- Custom Theme Style -->
	<link href="/base/stylesheets/bundle.min.css" rel="stylesheet">

</head>

<body class="nav-md">
	<div class="container body">
		<div class="main_container">

			<!-- left navigation -->
			<%- include('../partials/left_nav', {user: user}); %>
			<!-- /left navigation -->

			<!-- top navigation -->
			<%- include('../partials/top_nav', {user: user}); %>
			<!-- /top navigation -->

			<!-- page content -->
			<div class="right_col" role="main">
				<div class="">
					<div class="page-title">
						<div class="title_left" style="width: 100%;">
							<h3>My Dashboard <small>You can update your availability by dragging a time range</small></h3>
						</div>
					</div>

					<div class="clearfix"></div>

					<div class="row">
						<div class="col-md-12">
							<div class="x_panel">
								<div class="x_title">
									<h2>Schedule</h2>
									<ul class="nav navbar-right panel_toolbox">
										<li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
										</li>
										<li class="dropdown">
											<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
											<ul class="dropdown-menu" role="menu">
												<li><a href="#">Settings 1</a>
												</li>
												<li><a href="#">Settings 2</a>
												</li>
											</ul>
										</li>
										<li><a class="close-link"><i class="fa fa-close"></i></a>
										</li>
									</ul>
									<div class="clearfix"></div>
								</div>
								<div class="x_content">

									<div id='calendar'></div>

								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- /page content -->

			<!-- footer content -->
			<%- include('../partials/footer'); %>
			<!-- /footer content -->
<div id="CalenderModalEventDetails" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog">
		<div class="modal-content">

			<div class="modal-header">
				<button type="button" class="close close2" data-dismiss="modal" aria-hidden="true">Ã—</button>
				<h4 class="modal-title" id="myModalLabel2">Session Details</h4>
			</div>
			<div class="modal-body">

				<div id="testmodal2" style="padding: 5px 20px;">
					<form id="antoform2" class="form-horizontal calender" role="form">
						<div class="form-group">
							<label class="col-sm-3 control-label">Start</label>
							<div class="col-sm-9">
								<input type="text" class="form-control" id="start" disabled>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">End</label>
							<div class="col-sm-9">
								<input type="text" class="form-control" id="end" disabled>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">Mentor</label>
							<div class="col-sm-9">
								<input type="text" class="form-control" id="mentor" disabled>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">Mentee</label>
							<div class="col-sm-9">
								<input type="text" class="form-control" id="mentee" disabled>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-3 control-label">Zoom Link</label>
							<div class="col-sm-9">
								<input type="text" class="form-control" id="zoom" disabled>
							</div>
						</div>

					</form>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" id='confirm' class="btn btn-success" style="margin: 0;">Confirm</button>
				<button type="button" id='refuse' class="btn btn-warning" style="margin: 0;">Refuse</button>
				<button type="button" id='delete' class="btn btn-danger antoupdate" style="margin: 0;">Delete</button>
				<button type="button" class="btn btn-default close2" data-dismiss="modal" style="margin: 0;">Close</button>
			</div>
		</div>
	</div>
</div>

<div id="event_details" data-toggle="modal" data-target="#CalenderModalEventDetails"></div>
<!-- /calendar modal -->

<!-- jQuery -->
<script src="/vendor/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="/vendor/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- FastClick -->
<script src="/vendor/fastclick/lib/fastclick.js"></script>
<!-- iCheck -->
<script src="/vendor/iCheck/icheck.min.js"></script>
<!-- gauge.js
<script src="/vendor/bernii/gauge.js/dist/gauge.min.js"></script>

<script src="/vendor/Chart.js/dist/Chart.min.js"></script>
-->
<!-- jQuery Sparklines -->
<script src="/vendor/jquery-sparkline/dist/jquery.sparkline.min.js"></script>
<!-- PNotify -->
<script src="/vendor/pnotify/dist/pnotify.js"></script>
<script src="/vendor/pnotify/dist/pnotify.buttons.js"></script>
<script src="/vendor/pnotify/dist/pnotify.nonblock.js"></script>
<!-- FullCalendar -->
<script src="/vendor/moment/min/moment.min.js"></script>
<script src="/vendor/moment/moment-timezone.js"></script>
<script src="/vendor/fullcalendar/dist/fullcalendar.min.js"></script>
<!-- Custom Theme Scripts -->
<script src="/vendor/gentelella/js/custom.min.js"></script>



<!-- FullCalendar -->
<script>
$(window).load(function() {

	var user = <%- JSON.stringify(user) %>;
	var calEvents = user.upcomingSessions

	var calendar = $('#calendar').fullCalendar({
		header: {
			left: 'prev,next today',
			center: 'title',
			right: 'month,agendaWeek,agendaDay'
		},
		timezone: 'local',
		defaultView: 'agendaWeek',
		selectable: true,
		selectHelper: true,
		selectOverlap: false,
		select: function(start, end) {
			if (calendar.fullCalendar( 'getView' ).name === 'month') {
				calendar.fullCalendar('unselect')
				return false
			}
			if (start < moment().add(24, 'h')) {
				new PNotify({
					title: 'Error',
					text: 'Your time slot must be booked 24 hours in advance!',
					type: 'warning',
					styling: "bootstrap3"
				});
				calendar.fullCalendar('unselect')
				return false
			}
			if(end-start > 1.08e+7) {
				new PNotify({
					title: 'Error',
					text: 'Time slot cannot be longer than 180 minutes',
					type: 'danger',
					styling: "bootstrap3"
				});
				calendar.fullCalendar('unselect')
				return false
			}

			$.post('/mentor/session/new/', {
				type: 'available',
				color: 'green',
				start: start.valueOf(),
				end: end.valueOf(),
				mentor: user._id,
			}).done(function (res) {
				new PNotify({
					title: 'Success',
					text: 'New Time Slot Created',
					type: 'success',
					styling: "bootstrap3"
				});
				calendar.fullCalendar('refetchEvents')
				calendar.fullCalendar('unselect')
			});
		},
		eventClick: function( calEvent, jsEvent, view ) {
			console.log(calEvent)
			if (['taken', 'noshow', 'finished'].indexOf(calEvent.type) !== -1)
				return false

			$('#event_details').click();
			$('#start').val(calEvent.start.format('dddd, MMMM Do YYYY, HH:mm'))
			$('#end').val(calEvent.end.format('dddd, MMMM Do YYYY, HH:mm'))
			$('#mentor').val(calEvent.mentor.profile.first_name + ' ' + calEvent.mentor.profile.last_name)
			$('#mentee').val(calEvent.mentee ? calEvent.mentee.profile.first_name + ' ' + calEvent.mentee.profile.last_name : '')
			if (calEvent.type === "requested") {
				$("#confirm").off().on("click", function() {
					$.ajax({
						url: '/mentor/session/confirm/'+calEvent._id,
						type: 'PUT',
						data: {
							type: 'taken',
							color: 'red',
						}
					}).done(function (res) {
						new PNotify({
							title: 'Session Confirmed',
							type: 'success',
							styling: "bootstrap3"
						});
						$('.close').click()
						calendar.fullCalendar('refetchEvents')
					})
				}).show()
				$("#refuse").off().on("click", function() {
					$.ajax({
						url: '/mentor/session/refuse/'+calEvent._id,
						type: 'PUT',
						data: {
							type: 'available',
							color: 'green',
						}
					}).done(function (res) {
						new PNotify({
							title: 'Request refused',
							type: 'warning',
							styling: "bootstrap3"
						});
						$('.close').click()
						calendar.fullCalendar('refetchEvents')
					})
				}).show()
				$("#delete").off().on("click", function() {
					$.ajax({
						url: '/mentor/session/delete/'+calEvent._id,
						type: 'DELETE',
					}).done(function (res) {
						new PNotify({
							title: 'Item Deleted',
							text: 'Time Slot Deleted',
							type: 'warning',
							styling: "bootstrap3"
						});
						$('.close').click()
						calendar.fullCalendar('refetchEvents')
					})
				}).show()
			}
			else {
				$("#confirm").hide()
				$("#refuse").hide()
				$("#delete").off().on("click", function() {
					$.ajax({
						url: '/mentor/session/delete/'+calEvent._id,
						type: 'DELETE',
					}).done(function (res) {
						new PNotify({
							title: 'Time slot deleted',
							text: 'Time Slot Deleted',
							type: 'warning',
							styling: "bootstrap3"
						});
						$('.close').click()
						calendar.fullCalendar('refetchEvents')
					})
				}).show()
			}
		},
		eventDrop: function(calEvent, delta, revertFunc, jsEvent) {
			if (calendar.fullCalendar( 'getView' ).name === 'month' || calEvent.type !== 'available') {
				revertFunc()
				return false
			}
			if (calEvent.start < moment().add(24, 'h')) {
				new PNotify({
					title: 'Error',
					text: 'Your time slot must be booked 24 hours in advance!',
					type: 'warning',
					styling: "bootstrap3"
				});
				revertFunc()
				return false
			}

			var start = calEvent.start
			var end = calEvent.end
			$.ajax({
				url: '/mentor/session/update/'+calEvent._id,
				type: 'PUT',
				data: {
					start: start.valueOf(),
					end: end.valueOf(),
				}
			}).done(function (res) {
				new PNotify({
					title: 'Success',
					text: 'Changes Saved',
					type: 'success',
					styling: "bootstrap3"
				});
			})
		},
		eventResize: function(calEvent, delta, revertFunc, jsEvent) {
			if (calendar.fullCalendar( 'getView' ).name === 'month' || calEvent.type !== 'available') {
				revertFunc()
				return false
			}
			if (calEvent.start < moment().add(24, 'h')) {
				new PNotify({
					title: 'Error',
					text: 'Your time slot must be booked 24 hours in advance!',
					type: 'warning',
					styling: "bootstrap3"
				});
				revertFunc()
				return false
			}
			if(calEvent.end - calEvent.start > 1.08e+7) {
				new PNotify({
					title: 'Error',
					text: 'Time slot cannot be longer than 180 minutes',
					type: 'danger',
					styling: "bootstrap3"
				});
				revertFunc()
				return false
			}

			var start = calEvent.start
			var end = calEvent.end
			$.ajax({
				url: '/mentor/session/update/'+calEvent._id,
				type: 'PUT',
				data: {
					start: start.valueOf(),
					end: end.valueOf(),
				}
			}).done(function (res) {
				new PNotify({
					title: 'Success',
					text: 'Changes Saved',
					type: 'success',
					styling: "bootstrap3"
				});
			})
		},
		eventRender: function(event, element) {
			element.append('Click for more details<br>Status: '+event.type)
		},
		editable: true,
		eventOverlap: false,
		events: '/session/byUserId/'+ user._id,
	});
});
</script>
<!-- /FullCalendar -->

<!-- jQuery Sparklines -->
<script>
$(document).ready(function() {
	$(".sparkline_one").sparkline([2, 4, 3, 4, 5, 4, 5, 4, 3, 4, 5, 6, 7, 5, 4, 3, 5, 6], {
		type: 'bar',
		height: '40',
		barWidth: 9,
		colorMap: {
			'7': '#a1a1a1'
		},
		barSpacing: 2,
		barColor: '#26B99A'
	});

	$(".sparkline_two").sparkline([2, 4, 3, 4, 5, 4, 5, 4, 3, 4, 5, 6, 7, 5, 4, 3, 5, 6], {
		type: 'line',
		width: '200',
		height: '40',
		lineColor: '#26B99A',
		fillColor: 'rgba(223, 223, 223, 0.57)',
		lineWidth: 2,
		spotColor: '#26B99A',
		minSpotColor: '#26B99A'
	});
});
</script>
<!-- /jQuery Sparklines -->

</body>
</html>
